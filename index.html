<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>D4 Meta Build Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100">
    <div id="root"></div>
    <script type="text/babel">
      const { useMemo, useState, useEffect } = React;

      const CLASSES = [
        { id: "barbarian", name: "Barbarian" },
        { id: "sorcerer", name: "Sorcerer" },
        { id: "rogue", name: "Rogue" },
        { id: "necromancer", name: "Necromancer" },
        { id: "druid", name: "Druid" },
        { id: "spiritborn", name: "Spiritborn" },
      ];

      function useUniques() {
        const [items, setItems] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        useEffect(() => {
          fetch("./public/uniques.json", { cache: "no-store" })
            .then((r) => r.json())
            .then((json) => setItems(json.items || []))
            .catch((e) => {
              console.error(e);
              setError(e);
            })
            .finally(() => setLoading(false));
        }, []);
        return { items, loading, error };
      }

      const byId = (arr) => Object.fromEntries(arr.map((x) => [x.id, x]));
      const classNameFromId = (id) => CLASSES.find((c) => c.id === id)?.name || id || "All Classes";

      function Badge({ children, rarity }) {
        let colorClass = "";
        if (rarity === "uber") {
          colorClass = "text-purple-400"; // purple for Uber
        } else if (rarity === "unique") {
          colorClass = "text-yellow-300"; // light gold for Unique
        }
        return (
          <span
            className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium ${colorClass}`}
          >
            {children}
          </span>
        );
      }

      function Section({ title, children, actions }) {
        return (
          <section className="bg-white/5 backdrop-blur rounded-2xl p-4 md:p-6 shadow-sm border border-white/10">
            <div className="flex items-center justify-between gap-3 mb-3">
              <h2 className="text-lg md:text-xl font-semibold">{title}</h2>
              {actions}
            </div>
            {children}
          </section>
        );
      }

      function ResultsLegend() {
        return (
          <div className="hidden md:flex items-center gap-2 text-xs opacity-80">
            <Badge>Score</Badge>
            <span>Required ×2 + optional</span>
          </div>
        );
      }

      function ResultsList({ builds }) {
        if (!builds || builds.length === 0) {
          return <div className="text-sm opacity-80">No curated builds yet.</div>;
        }
        return (
          <div className="grid grid-cols-1 gap-3">
            {builds.map((b) => (
              <article key={b.id} className="rounded-2xl border border-white/10 bg-white/5 p-4 shadow-sm">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <h3 className="text-base md:text-lg font-semibold flex items-center gap-2">
                      {b.name}
                      {b.complete && <Badge>All required found</Badge>}
                    </h3>
                    <div className="text-[12px] opacity-70">{classNameFromId(b.class)}</div>
                  </div>
                  <div className="text-right">
                    <div className="text-xl font-bold leading-none">{b.score}</div>
                    <div className="text-[11px] opacity-70">match</div>
                  </div>
                </div>
                <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs opacity-80 mb-1">Required</div>
                    <div className="flex flex-wrap gap-2">
                      {(b.requiredItems || []).map((id) => (
                        <span
                          key={id}
                          className={
                            "inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] border " +
                            (b.requiredHits?.includes(id)
                              ? "bg-emerald-500/15 border-emerald-400/40"
                              : "bg-white/5 border-white/15")
                          }
                        >
                          {id}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <div className="text-xs opacity-80 mb-1">Optional</div>
                    <div className="flex flex-wrap gap-2">
                      {(b.optionalItems || []).map((id) => (
                        <span
                          key={id}
                          className={
                            "inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] border " +
                            (b.optionalHits?.includes(id)
                              ? "bg-emerald-500/15 border-emerald-400/40"
                              : "bg-white/5 border-white/15")
                          }
                        >
                          {id}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
                {b.notes && <p className="text-sm opacity-90 mt-3">{b.notes}</p>}
                {b.sources?.length > 0 && (
                  <div className="mt-3 flex flex-wrap items-center gap-2 text-xs">
                    {b.sources.map((s, i) => (
                      <a
                        key={i}
                        href={s.url}
                        target="_blank"
                        rel="noreferrer"
                        className="underline opacity-90 hover:opacity-100"
                      >
                        {s.label}
                      </a>
                    ))}
                  </div>
                )}
              </article>
            ))}
          </div>
        );
      }

      function App() {
        const { items, loading, error } = useUniques();
        const ITEM_INDEX = useMemo(() => byId(items), [items]);
        const url = new URL(window.location.href);
        const [activeClass, setActiveClass] = useState(url.searchParams.get("cls") || "");
        const [selectedItems, setSelectedItems] = useState(() => {
          const raw = url.searchParams.get("items");
          return new Set((raw ? raw.split(",") : []).filter((id) => id && id in ITEM_INDEX));
        });
        const [query, setQuery] = useState("");

        useEffect(() => {
          const params = new URLSearchParams(window.location.search);
          if (activeClass) params.set("cls", activeClass);
          else params.delete("cls");
          const itemsCsv = [...selectedItems].join(",");
          if (itemsCsv) params.set("items", itemsCsv);
          else params.delete("items");
          window.history.replaceState({}, "", `${window.location.pathname}?${params}`);
        }, [activeClass, selectedItems]);

        const itemsFiltered = useMemo(() => {
          const q = query.trim().toLowerCase();
          return items
            .filter((it) => {
              const textMatch = !q || `${it.name} ${it.slot}`.toLowerCase().includes(q);
              const hints = it.class ? [it.class] : [];
              const classMatch = !activeClass || hints.length === 0 || hints.includes(activeClass);
              return textMatch && classMatch;
            })
            .sort((a, b) => a.name.localeCompare(b.name));
        }, [items, query, activeClass]);

        const BUILDS = useMemo(() => [], []);

        const buildsForClass = useMemo(() => {
          const pool = activeClass ? BUILDS.filter((b) => b.class === activeClass) : BUILDS;
          const have = selectedItems;
          return pool
            .map((b) => {
              const requiredHits = (b.requiredItems || []).filter((id) => have.has(id));
              const optionalHits = (b.optionalItems || []).filter((id) => have.has(id));
              const missingRequired = (b.requiredItems || []).filter((id) => !have.has(id));
              const score = requiredHits.length * 2 + optionalHits.length;
              const complete = missingRequired.length === 0 && requiredHits.length > 0;
              return { ...b, score, requiredHits, optionalHits, missingRequired, complete };
            })
            .sort((a, b) => b.score - a.score);
        }, [BUILDS, activeClass, selectedItems]);

        const toggleItem = (id) => {
          setSelectedItems((prev) => {
            const next = new Set(prev);
            if (next.has(id)) next.delete(id);
            else next.add(id);
            return next;
          });
        };
        const clearAll = () => setSelectedItems(new Set());

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100 p-3 md:p-6">
            <header className="max-w-6xl mx-auto mb-4 md:mb-8">
              <div className="flex items-center justify-between gap-2">
                <h1 className="text-2xl md:text-3xl font-bold tracking-tight">D4 Meta Build Finder</h1>
                <a
                  href="https://d4builds.gg/database/uniques/"
                  target="_blank"
                  rel="noreferrer"
                  className="text-xs md:text-sm opacity-70 hover:opacity-100 underline"
                >
                  Data source (uniques)
                </a>
              </div>
              {error && (
                <p className="text-xs mt-2 text-red-300">
                  Could not load uniques.json; showing fallback set.
                </p>
              )}
            </header>
            <main className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-4 md:gap-6">
              <div className="lg:col-span-2 space-y-4 md:space-y-6">
                <Section title="Class" actions={activeClass && (
                  <button onClick={() => setActiveClass("")} className="text-xs underline opacity-80 hover:opacity-100">Clear</button>
                )}>
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    {CLASSES.map((c) => (
                      <button
                        key={c.id}
                        onClick={() => setActiveClass((prev) => (prev === c.id ? "" : c.id))}
                        className={
                          "rounded-2xl border px-3 py-2 text-sm text-left shadow-sm transition " +
                          (activeClass === c.id
                            ? "border-emerald-400/60 bg-emerald-400/10"
                            : "border-white/10 hover:bg-white/5")
                        }
                      >
                        <div className="font-medium">{c.name}</div>
                      </button>
                    ))}
                  </div>
                </Section>

                <Section
                  title="Your Uniques"
                  actions={selectedItems.size > 0 && (
                    <button onClick={clearAll} className="text-xs underline opacity-80 hover:opacity-100">
                      Clear all
                    </button>
                  )}
                >
                  <div className="relative mb-3">
                    <input
                      type="text"
                      value={query}
                      onChange={(e) => setQuery(e.target.value)}
                      placeholder="Search by name or slot…"
                      className="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm outline-none focus:border-white/20"
                    />
                  </div>
                  {loading ? (
                    <div className="text-sm opacity-80">Loading uniques…</div>
                  ) : (
                    <div className="max-h-[26rem] overflow-auto pr-1 space-y-2">
                      {itemsFiltered.map((it) => (
                        <label
                          key={it.id}
                          className="flex items-center justify-between gap-3 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm hover:bg-white/10"
                        >
                          <div className="min-w-0">
                            <div className="font-medium truncate">{it.name}</div>
                            <div className="text-[11px] opacity-70 truncate">{it.slot || "Slot unknown"}</div>
                          </div>
                          <div className="flex items-center gap-2">
                            <Badge rarity={it.rarity}>
                              {(it.rarity === "uber" || /mythic/i.test(it.rarity)) ? "Uber" : "Unique"}
                            </Badge>
                            <input
                              type="checkbox"
                              className="w-4 h-4 accent-emerald-400"
                              checked={selectedItems.has(it.id)}
                              onChange={() => toggleItem(it.id)}
                            />
                          </div>
                        </label>
                      ))}
                      {itemsFiltered.length === 0 && (
                        <div className="text-xs opacity-70">
                          No items found. Try a different search or class filter.
                        </div>
                      )}
                    </div>
                  )}
                </Section>
              </div>
              <div className="lg:col-span-3 space-y-4 md:space-y-6">
                <Section title="Matching Builds" actions={<ResultsLegend />}>
                  <ResultsList builds={buildsForClass} />
                </Section>
              </div>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
